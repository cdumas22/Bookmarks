/**
*  Ajax Autocomplete for jQuery, version 1.2.7
*  (c) 2013 Tomas Kirda
*
*  Ajax Autocomplete for jQuery is freely distributable under the terms of an MIT-style license.
*  For details, see the web site: http://www.devbridge.com/projects/autocomplete/jquery/
*
*/

define("text!Bookmark/Templates/Item.html",[],function(){return'<ul class="breadcrumb">\r\n  <li><a href="#bookmarks">Bookmarks</a> <span class="divider">/</span></li>\r\n  <li class="active"><%=title%></li>\r\n</ul>\r\n<% if(lock === true || lock === "true") {%>\r\n<div class="lock pull-right btn btn-danger">LOCKED</div>\r\n<% } %>\r\n<div class="title">\r\n    <p>TITLE:</p><input class="edit" type="text" name="title" value="<%=title%>" placeholder="Title"/>\r\n</div>\r\n<div>\r\n    <p>DESCRIPTION:</p> <textarea class="edit" name="description"  placeholder="Description" style="height:100px;"><%=description%></textarea>\r\n</div>\r\n<div>\r\n    <p>URL:</p> <input class="edit" type="text" name="url" value="<%=url%>" placeholder="URL"/>\r\n</div>\r\n<div>\r\n    <p>TAGS:</p> <input class="edit" type="text" name="tags" value="<%=tags%>" placeholder="Tags"/>\r\n</div>\r\n<div class="edit form-actions">\r\n    <button class="save btn btn-primary" type="submit">Save</button>\r\n    <a href="#bookmarks" class="cancel btn btn-default">cancel</a>\r\n</div>\r\n\r\n\r\n'}),function(e){"function"==typeof define&&define.amd?define("autocomplete",["jquery"],e):e(jQuery)}(function(e){function t(n,r){var i=function(){},i={autoSelectFirst:!1,appendTo:"body",serviceUrl:null,lookup:null,onSelect:null,width:"auto",minChars:1,maxHeight:300,deferRequestBy:0,params:{},formatResult:t.formatResult,delimiter:null,zIndex:9999,type:"GET",noCache:!1,onSearchStart:i,onSearchComplete:i,containerClass:"autocomplete-suggestions",tabDisabled:!1,dataType:"text",lookupFilter:function(e,t,n){return-1!==e.value.toLowerCase().indexOf(n)},paramName:"query",transformResult:function(t){return"string"==typeof t?e.parseJSON(t):t}};this.element=n,this.el=e(n),this.suggestions=[],this.badQueries=[],this.selectedIndex=-1,this.currentValue=this.element.value,this.intervalId=0,this.cachedResponse=[],this.onChange=this.onChangeInterval=null,this.isLocal=this.ignoreValueChange=!1,this.suggestionsContainer=null,this.options=e.extend({},i,r),this.classes={selected:"autocomplete-selected",suggestion:"autocomplete-suggestion"},this.initialize(),this.setOptions(r)}var n={extend:function(t,n){return e.extend(t,n)},createNode:function(e){var t=document.createElement("div");return t.innerHTML=e,t.firstChild}};t.utils=n,e.Autocomplete=t,t.formatResult=function(e,t){var n="("+t.replace(RegExp("(\\/|\\.|\\*|\\+|\\?|\\||\\(|\\)|\\[|\\]|\\{|\\}|\\\\)","g"),"\\$1")+")";return e.value.replace(RegExp(n,"gi"),"<strong>$1</strong>")},t.prototype={killerFn:null,initialize:function(){var n=this,r="."+n.classes.suggestion,i=n.classes.selected,s=n.options,o;n.element.setAttribute("autocomplete","off"),n.killerFn=function(t){0===e(t.target).closest("."+n.options.containerClass).length&&(n.killSuggestions(),n.disableKillerFn())};if(!s.width||"auto"===s.width)s.width=n.el.outerWidth();n.suggestionsContainer=t.utils.createNode('<div class="'+s.containerClass+'" style="position: absolute; display: none;"></div>'),o=e(n.suggestionsContainer),o.appendTo(s.appendTo).width(s.width),o.on("mouseover.autocomplete",r,function(){n.activate(e(this).data("index"))}),o.on("mouseout.autocomplete",function(){n.selectedIndex=-1,o.children("."+i).removeClass(i)}),o.on("click.autocomplete",r,function(){n.select(e(this).data("index"),!1)}),n.fixPosition(),window.opera?n.el.on("keypress.autocomplete",function(e){n.onKeyPress(e)}):n.el.on("keydown.autocomplete",function(e){n.onKeyPress(e)}),n.el.on("keyup.autocomplete",function(e){n.onKeyUp(e)}),n.el.on("blur.autocomplete",function(){n.onBlur()}),n.el.on("focus.autocomplete",function(){n.fixPosition()})},onBlur:function(){this.enableKillerFn()},setOptions:function(t){var r=this.options;n.extend(r,t);if(this.isLocal=e.isArray(r.lookup))r.lookup=this.verifySuggestionsFormat(r.lookup);e(this.suggestionsContainer).css({"max-height":r.maxHeight+"px",width:r.width+"px","z-index":r.zIndex})},clearCache:function(){this.cachedResponse=[],this.badQueries=[]},clear:function(){this.clearCache(),this.currentValue=null,this.suggestions=[]},disable:function(){this.disabled=!0},enable:function(){this.disabled=!1},fixPosition:function(){var t;"body"===this.options.appendTo&&(t=this.el.offset(),e(this.suggestionsContainer).css({top:t.top+this.el.outerHeight()+"px",left:t.left+"px"}))},enableKillerFn:function(){e(document).on("click.autocomplete",this.killerFn)},disableKillerFn:function(){e(document).off("click.autocomplete",this.killerFn)},killSuggestions:function(){var e=this;e.stopKillSuggestions(),e.intervalId=window.setInterval(function(){e.hide(),e.stopKillSuggestions()},300)},stopKillSuggestions:function(){window.clearInterval(this.intervalId)},onKeyPress:function(e){if(!this.disabled&&!this.visible&&40===e.keyCode&&this.currentValue)this.suggest();else if(!this.disabled&&this.visible){switch(e.keyCode){case 27:this.el.val(this.currentValue),this.hide();break;case 9:case 13:if(-1===this.selectedIndex){this.hide();return}this.select(this.selectedIndex,13===e.keyCode);if(9===e.keyCode&&!1===this.options.tabDisabled)return;break;case 38:this.moveUp();break;case 40:this.moveDown();break;default:return}e.stopImmediatePropagation(),e.preventDefault()}},onKeyUp:function(e){var t=this;if(!t.disabled){switch(e.keyCode){case 38:case 40:return}clearInterval(t.onChangeInterval),t.currentValue!==t.el.val()&&(0<t.options.deferRequestBy?t.onChangeInterval=setInterval(function(){t.onValueChange()},t.options.deferRequestBy):t.onValueChange())}},onValueChange:function(){var e;clearInterval(this.onChangeInterval),this.currentValue=this.element.value,e=this.getQuery(this.currentValue),this.selectedIndex=-1,this.ignoreValueChange?this.ignoreValueChange=!1:e.length<this.options.minChars?this.hide():this.getSuggestions(e)},getQuery:function(t){var n=this.options.delimiter;return n?(t=t.split(n),e.trim(t[t.length-1])):e.trim(t)},getSuggestionsLocal:function(t){var n=t.toLowerCase(),r=this.options.lookupFilter;return{suggestions:e.grep(this.options.lookup,function(e){return r(e,t,n)})}},getSuggestions:function(t){var n,r=this,i=r.options,s=i.serviceUrl;(n=r.isLocal?r.getSuggestionsLocal(t):r.cachedResponse[t])&&e.isArray(n.suggestions)?(r.suggestions=n.suggestions,r.suggest()):r.isBadQuery(t)||(i.params[i.paramName]=t,!1!==i.onSearchStart.call(r.element,i.params)&&(e.isFunction(i.serviceUrl)&&(s=i.serviceUrl.call(r.element,t)),e.ajax({url:s,data:i.ignoreParams?null:i.params,type:i.type,dataType:i.dataType}).done(function(e){r.processResponse(e,t),i.onSearchComplete.call(r.element,t)})))},isBadQuery:function(e){for(var t=this.badQueries,n=t.length;n--;)if(0===e.indexOf(t[n]))return!0;return!1},hide:function(){this.visible=!1,this.selectedIndex=-1,e(this.suggestionsContainer).hide()},suggest:function(){if(0===this.suggestions.length)this.hide();else{var t=this.options.formatResult,n=this.getQuery(this.currentValue),r=this.classes.suggestion,i=this.classes.selected,s=e(this.suggestionsContainer),o="";e.each(this.suggestions,function(e,i){o+='<div class="'+r+'" data-index="'+e+'">'+t(i,n)+"</div>"}),s.html(o).show(),this.visible=!0,this.options.autoSelectFirst&&(this.selectedIndex=0,s.children().first().addClass(i))}},verifySuggestionsFormat:function(t){return t.length&&"string"==typeof t[0]?e.map(t,function(e){return{value:e,data:null}}):t},processResponse:function(e,t){var n=this.options,r=n.transformResult(e,t);r.suggestions=this.verifySuggestionsFormat(r.suggestions),n.noCache||(this.cachedResponse[r[n.paramName]]=r,0===r.suggestions.length&&this.badQueries.push(r[n.paramName])),t===this.getQuery(this.currentValue)&&(this.suggestions=r.suggestions,this.suggest())},activate:function(t){var n=this.classes.selected,r=e(this.suggestionsContainer),i=r.children();return r.children("."+n).removeClass(n),this.selectedIndex=t,-1!==this.selectedIndex&&i.length>this.selectedIndex?(t=i.get(this.selectedIndex),e(t).addClass(n),t):null},select:function(e,t){var n=this.suggestions[e];n&&(this.el.val(n),this.ignoreValueChange=t,this.hide(),this.onSelect(e))},moveUp:function(){-1!==this.selectedIndex&&(0===this.selectedIndex?(e(this.suggestionsContainer).children().first().removeClass(this.classes.selected),this.selectedIndex=-1,this.el.val(this.currentValue)):this.adjustScroll(this.selectedIndex-1))},moveDown:function(){this.selectedIndex!==this.suggestions.length-1&&this.adjustScroll(this.selectedIndex+1)},adjustScroll:function(t){var n=this.activate(t),r,i;n&&(n=n.offsetTop,r=e(this.suggestionsContainer).scrollTop(),i=r+this.options.maxHeight-25,n<r?e(this.suggestionsContainer).scrollTop(n):n>i&&e(this.suggestionsContainer).scrollTop(n-this.options.maxHeight+25),this.el.val(this.getValue(this.suggestions[t].value)))},onSelect:function(t){var n=this.options.onSelect;t=this.suggestions[t],this.el.val(this.getValue(t.value)),e.isFunction(n)&&n.call(this.element,t)},getValue:function(e){var t=this.options.delimiter,n;return t?(n=this.currentValue,t=n.split(t),1===t.length?e:n.substr(0,n.length-t[t.length-1].length)+e):e},dispose:function(){this.el.off(".autocomplete").removeData("autocomplete"),this.disableKillerFn(),e(this.suggestionsContainer).remove()}},e.fn.autocomplete=function(n,r){return 0===arguments.length?this.first().data("autocomplete"):this.each(function(){var i=e(this),s=i.data("autocomplete");"string"==typeof n?s&&"function"==typeof s[n]&&s[n](r):(s&&s.dispose&&s.dispose(),s=new t(this,n),i.data("autocomplete",s))})}}),define("Bookmark/Views/Item",["backbone","underscore","text!Bookmark/Templates/Item.html","autocomplete"],function(e,t,n){return e.View.extend({className:"bookmark-view",template:t.template(n),events:{"click button.save":"save","click button.cancel":"edit","click .icon-remove":"remove_tag"},initialize:function(e){e||(e={}),this.model=e.model,this.collection=e.collection||this.model.collection,this.model&&(this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"remove",this.root)),this.initializeLock()},initializeLock:function(){var e=this;this.model&&this.listenTo(this,"remove",function(){this.model.unlock(),$(window).off("unload")}),$(window).on("unload",function(){e.model.unlock({async:!1}),$(window).off("unload")})},remove:function(){this.trigger("remove"),e.View.prototype.remove.call(this)},render:function(){return this.model.unlock(),this.$el.html(this.template(this.model.toJSON())),this.$el.find("input[name=tags]").autocomplete({lookup:this.collection.tags(),delimiter:",",maxHeight:80,width:300}),this.model.isNew()&&this.$el.addClass("editing"),this},root:function(){window.location.hash="bookmarks"},edit:function(){this.model.isNew()&&this.root();if(!this.$el.hasClass("editing")&&this.model.get("lock")===!0)return!1;this.$el.hasClass("editing")?(this.$el.removeClass("editing"),this.model.unlock()):(this.$el.addClass("editing"),this.model.lock())},save:function(e){e.stopPropagation(),e.preventDefault();var t=this.$el.find("input[name=tags]").val().split(",");for(var n=0;n<t.length;n++)t[n]=t[n].replace(/^\s*|\s*$/g,"").toLowerCase();this.model.set({title:this.$el.find("input[name=title]").val(),description:this.$el.find("textarea[name=description]").val(),url:this.$el.find("input[name=url]").val(),tags:t,lock:!1}),this.edit(),this.model.isNew()?(this.model.set("created",new Date),this.collection.create(this.model,{wait:!0})):this.model.save(),window.location="#bookmarks"}})});